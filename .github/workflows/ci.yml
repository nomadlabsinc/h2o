name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CRYSTAL_VERSION: 1.16.0

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    container:
      image: robnomad/crystal:${{ env.CRYSTAL_VERSION }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: shards install

    - name: Run tests
      run: crystal spec --verbose

    - name: Run tests with coverage
      run: |
        crystal spec --coverage
        
  lint:
    name: Lint
    runs-on: ubuntu-latest
    container:
      image: robnomad/crystal:${{ env.CRYSTAL_VERSION }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: shards install

    - name: Check formatting
      run: crystal tool format --check

    - name: Run Ameba linter
      run: ./bin/ameba

  build:
    name: Build
    runs-on: ubuntu-latest
    container:
      image: robnomad/crystal:${{ env.CRYSTAL_VERSION }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: shards install

    - name: Build release
      run: crystal build src/h2o.cr --release --no-debug

    - name: Build documentation
      run: crystal docs
      
    - name: Upload documentation
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: docs/

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    container:
      image: robnomad/crystal:${{ env.CRYSTAL_VERSION }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: shards install

    - name: Security audit
      run: |
        # Check for known security issues in dependencies
        shards check

    - name: Check for secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD