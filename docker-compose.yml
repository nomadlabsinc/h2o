services:
  app:
    build:
      context: .
      dockerfile: Dockerfile.test
    platform: linux/amd64
    volumes:
      - .:/workspace
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /workspace
    depends_on:
      - httpbin
      - nghttpd
    environment:
      - TEST_HTTPBIN_URL=http://httpbin:80
      - TEST_NGHTTPD_URL=https://nghttpd:4430
      - H2O_VERIFY_SSL=false
      - DOCKER_HOST=unix:///var/run/docker.sock
    command: crystal spec
    privileged: true

  httpbin:
    image: kennethreitz/httpbin
    platform: linux/amd64
    ports:
      - "8080:80"

  nghttpd:
    image: "svagi/nghttp2"
    platform: linux/amd64
    ports:
      - "8443:4430"
    volumes:
      - ./spec/integration/ssl/cert.pem:/srv/cert.pem
      - ./spec/integration/ssl/key.pem:/srv/key.pem
      - ./spec/integration:/srv
    command:
      - "nghttpd"
      - "-v"
      - "--htdocs=/srv"
      - "4430"
      - "/srv/key.pem"
      - "/srv/cert.pem"

  h2spec:
    build:
      context: ./h2spec
    platform: linux/amd64
    command: -h nghttpd -p 4430 -k -t
    depends_on:
      - nghttpd
